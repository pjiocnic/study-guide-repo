This example will demonstrate how to enable a Kubernetes pod running in an Amazon EKS cluster to access resources in another AWS account using role chaining. The pod will assume an IAM role in the EKS account, which will then assume a role in the target account.

**Prerequisites**

1. Two AWS accounts: Account A (EKS cluster account) and Account B (target account).
2. An EKS cluster in Account A.
3. IAM roles for both accounts.

**Steps**
Step 1: Create IAM Role for EKS in Account A
Create an IAM Role that EKS pods can assume.

```json
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Principal": {
                "Service": "eks.amazonaws.com"
            },
            "Action": "sts:AssumeRole"
        }
    ]
}
```

Attach a policy to this role allowing it to assume the target role in Account B.

```json
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Action": "sts:AssumeRole",
            "Resource": "arn:aws:iam::AccountB-ID:role/TargetRole"
        }
    ]
}
```

Step 2: Create Target IAM Role in Account B
Create an IAM Role in Account B that trusts the role from Account A.

```json
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Principal": {
                "AWS": "arn:aws:iam::AccountA-ID:role/EKSRole"
            },
            "Action": "sts:AssumeRole"
        }
    ]
}
```

Attach policies to this role to allow necessary actions (e.g., access to an S3 bucket).

```json
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Action": [
                "s3:ListBucket",
                "s3:GetObject"
            ],
            "Resource": [
                "arn:aws:s3:::example-bucket",
                "arn:aws:s3:::example-bucket/*"
            ]
        }
    ]
}
```

Step 3: Create an IAM Identity Mapping for EKS
Create a Kubernetes service account with the IAM role for pods to use in Account A.

```yaml
apiVersion: v1
kind: ServiceAccount
metadata:
  name: pod-access-sa
  namespace: default
  annotations:
    eks.amazonaws.com/role-arn: "arn:aws:iam::AccountA-ID:role/EKSRole"
```

Apply this service account to the cluster.

```sh
kubectl apply -f service-account.yaml
```

Step 4: Update EKS OIDC Provider
Associate the OIDC provider with your EKS cluster if itâ€™s not already associated.
sh
Copy code
eksctl utils associate-iam-oidc-provider --region region-code --cluster cluster-name --approve
Create an IAM Identity Mapping for the EKS role.
sh
Copy code
eksctl create iamidentitymapping --cluster cluster-name --namespace default --service-account pod-access-sa --arn arn:aws:iam::AccountA-ID:role/EKSRole --username pod-access-sa
Step 5: Update the Kubernetes Deployment
Create a deployment that uses the service account.
yaml
Copy code
apiVersion: apps/v1
kind: Deployment
metadata:
  name: example-deployment
  namespace: default
spec:
  replicas: 1
  selector:
    matchLabels:
      app: example
  template:
    metadata:
      labels:
        app: example
    spec:
      serviceAccountName: pod-access-sa
      containers:
      - name: example-container
        image: amazonlinux
        command: ["/bin/sh", "-c", "while true; do sleep 10000; done"]
Apply this deployment to the cluster.
sh
Copy code
kubectl apply -f deployment.yaml
Step 6: Assume the Role in the Application
Inside the pod, use the AWS SDK or CLI to assume the target role in Account B.
sh
Copy code
aws sts assume-role --role-arn arn:aws:iam::AccountB-ID:role/TargetRole --role-session-name PodAccessSession
Set environment variables for the temporary credentials.
sh
Copy code
export AWS_ACCESS_KEY_ID=your-access-key-id
export AWS_SECRET_ACCESS_KEY=your-secret-access-key
export AWS_SESSION_TOKEN=your-session-token
Access the S3 bucket in Account B.
sh
Copy code
aws s3 ls s3://example-bucket
Summary
Create an IAM role in Account A that allows EKS pods to assume it.
Create an IAM role in Account B that allows the role from Account A to assume it.
Create a Kubernetes service account and associate it with the IAM role from Account A.
Deploy a pod that uses this service account.
Assume the target role inside the pod and access resources in Account B.